
### Overview

`trace_process.py`: Simulate RAVEN defense and the adversary's reconstruction attacks, and generate the corresponding traffic traces observed by the adversary.

`format_convert.py`: Convert the trace format based on the target website fingerprinting attacks and defenses evaluation framework.

`create_train_test.py`: Prepare the traces for Tik-Tok attacks.

`utils/gen_dist.py`: Generate the distribution data for simulation (`dist.db` is ready to use).

`utils/tiktok_eval_func.py:` Two additional evaluation functions for Tik-Tok attacks.


### Setup

(1) RAVEN defense and reconstruction attack simulation

Python: 3.6.2
pip: 20.1.1
```
    pip install -r requirements.txt 
```
The dependency for the simulation scripts is very simple -- only `numpy`, so other Python 3 versions should work. 

(2) Other website fingerprinting attacks and defenses

Please check the corresponding repos for specific requirements and setup instructions

DF/Tik-Tok attacks: https://github.com/msrocean/Tik_Tok
Other attacks and defenses: https://github.com/websitefingerprinting/WebsiteFingerprinting

**OR** use the files in `conda_env` to create the conda environment


```
    conda create --name myenv --file raven_spec.txt
    conda env update --prefix [path to myenv] --file raven_env.yml  --prune
```


### trace_process.py

Simulate RAVEN defense and reconstruction attacks, and generate the traces of the flows seen by the adversary. 

|  option | desc  |detail|
| ------------ | ------------ | ------------ |
| i  | input  trace path   | **trace name**: siteNo_instNo <br> (unmonitored site's instNo is 0) <br> **trace format**: time, direction * size, flowID <br> (comma as delimiter)|
|  o | output trace path  | **trace name**: siteNo_instNo <br> **trace format**: time, direction * size <br> (comma as delimiter) |
|  m | simulation method | **0 (default)**: use the subflows generated by RAVEN  <br> **1**: use simulated subflows generated based on a given migration frequency  <br> **2**:  randomly sample a fraction of packets as the  flow |
| et | error type | **0 (default)**: missing  <br> **1**: wrongly-included  <br>**2**:  both errors |
| er | error rate  | a float number in [0, 1] <br> **default**: 0.1 (10%)|
|  f |  migration frequency | a postive int number. <br> If f = -1, perform random migration <br> **default**: 10|
|  d | path of packet distribution database  | the data can be generated via utils/gen_dist.py|
|  rs | random seed  | set the seed for random function. <br> **default**: not set |
|  h | print help  |   --  |

Simulation of wrongly-included errors (`et = 1 or 2`) needs to generate synthetic flows for every trace. This process is slow and may take hours.  

Examples:

Simulate the case that the adversary fails to include a subflow (missing error) in the reconstructed flow with a probability of 20%. Use simulated subflows and the migration frequency is 20 outgoing packets. The traces produced represent the reconstructed flows. 

```
python trace_process.py -i trace_in -o trace_out  -m 1 -et 0 -er 0.2 -f 20
```
Simulate the case that the adversary include a wrong subflow (wrongly-included error) in the reconstructed flow with a probability of 10%. Use the subflows produced by RAVEN.  The wrong subflows are generated based on the reference traffic stats in dist.db.
```
python trace_process.py -i trace_in -o trace_out  -m 0 -et 1 -er 0.1 -d dist.db
```

Simulate the case that the adversary fails to include a subflow (missing error) in the reconstructed flow with a probability of 20%. Use simulated subflows and random migration frequency.

- Run the command below multiple times will produce different traces
```
python trace_process.py -i trace_in -o trace_out  -m 1 -et 0 -er 0.2 -f -1
```
- If the **rs** option is set, run the command below multiple times will produce the same traces
```
python trace_process.py -i trace_in -o trace_out  -m 1 -et 0 -er 0.2 -f -1 -rs 1000
```

Only use the first subflow for training and testing (set `er  >= 1.0` to drop all the other subflows)
```
python trace_process.py -i trace_in -o trace_out -m 0 -et 0 -er 1.0
```

Use the original flow for training and testing (set `f to a large value` to keep all subflows)
```
python trace_process.py -i trace_in -o trace_out -m 1 -et 0 -er 0 -f 1000000
```

### format_convert.py 

Convert the format of trace and trace name to  make the traces compatible with other website fingerprinting attack and defense frameworks. 

The format of the input traces is fixed, and they are expected be the traces produced by **trace_process.py**

|  option | desc  |detail|
| ------------ | ------------ | ------------ |
| i  | input  trace path   | **trace name**: siteNo_instNo <br>**trace format**: time, direction * size <br> (comma as delimiter)|
|  o | output trace path  | --  |
|  td | trace delimiter | **c (default)**: comma <br> **t**: tab <br> **s**: space  |
|  fd | trace name delimiter  | dash (-) or underscore (\_) <br> **default**: \_  | 
|  ns | if remove size  | if set, only keep direction info <br> **default**: not set  |
|  h | print help  |   --  |

Examples:

The converted traces use tab as the delimiter, and trace name format is "siteNo-instNo" (for DF/Tik-Tok attacks)

```
python format_convert.py -i trace_in -o trace_out  -td t -fd "-"
```

Some attacks may only require the traces to be in the format of "time, direction"

```
python format_convert.py -i trace_in -o trace_out -td t -ns
```

### create_train_test.py

In the Tik-Tok attacks, the monitor and unmonitored traces are stored in the different directories. One can run `format_convert.py` and then `create_train_test.py` to create compatible traces for Tik-Tok attacks.

The script will also split the traces into monitor/unmonitored train/test sets based on **config.ini**, and store them into corresponding directories.

If the **rs** option is set, run the command multiple times will always produce the same train/test sets.


```
python create_train_test.py -i trace_in -o trace_out  
```


